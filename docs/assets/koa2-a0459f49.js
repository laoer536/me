import{o as s,c as a,a as p}from"./index-73d57d4b.js";const t={class:"markdown-body"},o=p(`<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/388d7aa477a848aba1c44c26e5f8b58a~tplv-k3u1fbpfcp-zoom-crop-mark:3024:3024:3024:1702.awebp?" alt="koa2+mongodb"><p>æˆ‘æ˜¯ä¸€åå‰ç«¯å°èœé¸¡ï¼Œå¹³æ—¥é‡Œå†™å†™é¡µé¢ï¼Œå†™å†™ BUGï¼Œå¹¶ä¹æ­¤ä¸ç–²ï¼Œéå¸¸æ»¡è¶³ã€‚å½“æœ‰ä¸€å¤©ï¼Œæˆ‘çªç„¶æƒ³æƒ³ï¼Œæˆ‘å¦‚æœè‡ªå·±è¦åšä¸€ä¸ªå®Œæ•´çš„é¡¹ç›®ï¼Œé‚£æˆ‘å°±éœ€è¦æ•°æ®æ¥å¸®å¿™å‘€ï¼Œå¯æ˜¯æ•°æ®å¾—è¦åç«¯å¤§ä½¬ä»¬å†™æ¥å£ç»™æˆ‘æ‰è¡Œï¼Œè™½ç„¶æˆ‘çš„ç¨‹åºå‘˜æœ‹å‹è¿˜æ˜¯æœ‰ä¸€ç±³ç±³ï¼Œä½†å¤§ä½¬ä¸€èˆ¬éƒ½å¿™å‘€ï¼Œå®åœ¨ä¸å¥½æ„æ€æ‹‰ç€ï¼Œäºæ˜¯æˆ‘å°±æƒ³ï¼Œæˆ‘æ˜¯å¦å¯ä»¥è‡ªå·±æ¥å†™æ¥å£å‘¢ï¼Ÿ</p><p>äºæ˜¯æˆ‘æµè§ˆä¸‡åƒç½‘é¡µï¼Œé€‰æ‹©äº†ä¸€ä¸ªä¸ç”¨å¤ªå·ï¼ˆä¸»è¦æ˜¯å·ä¸åŠ¨äº† ğŸ˜¥ï¼‰ï¼Œå¯¹å‰ç«¯å‹å¥½çš„ nodejs æ¥åšåå°å¼€å‘ã€‚ä¸è¯´å¤ªå¤šåºŸè¯ï¼Œå¼€æ•´ï¼</p><p><strong>1ã€å®‰è£… mongodb</strong></p><p>åœ°å€ï¼š<a href="https://link.juejin.cn?target=https%3A%2F%2Fwww.mongodb.com%2Ftry%2Fdownload%2Fenterprise" target="_blank" rel="noopener">MongoDB Community Download | MongoDB</a></p><p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5638e11148d3416dbeb216f8f0e1eafb~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?" alt="image.png"></p><p>å…·ä½“åç»­æ­¥éª¤<a href="https://www.runoob.com/mongodb/mongodb-window-install.html" target="_blank" rel="noopener">Windows å¹³å°å®‰è£… MongoDB | èœé¸Ÿæ•™ç¨‹ (runoob.com)</a></p><p>å’Œé“¾æ¥ä¸­çš„æ­¥éª¤å”¯ä¸€ä¸åŒçš„æ˜¯æˆ‘æ˜¯å®‰è£…äº†<code>Mongodb Compass</code>çš„ï¼Œå®˜æ–¹çš„æ•°æ®åº“å›¾å½¢åŒ–ç®¡ç†å·¥å…·è¿˜æ˜¯å¾ˆä¸é”™çš„ã€‚</p><p><strong>2ã€ä¸‹è½½ä¾èµ–</strong></p><p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c87484c359934d78b3a0d9ef05d13ecd~tplv-k3u1fbpfcp-zoom-in-crop-mark:1304:0:0:0.awebp?" alt="package.jsonä¾èµ–.png"></p><p><strong>3ã€å¯¹ä¾èµ–è¿›è¡Œé…ç½®ï¼ˆæˆ‘ç»Ÿä¸€æ”¾åœ¨äº† setting ç›®å½•ä¸‹ï¼‰</strong></p><p>jwt</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-jwt&#39;</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">jwt</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">secret</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unless</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^\\/public</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\/login</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\\/web</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">]</span> <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token comment">//tokené‰´æƒå¿½ç•¥publicå’Œloginã€webå¼€å¤´çš„æ¥å£</span>
<span class="token comment">//koa-jwté»˜è®¤é…ç½®ä¸‹ å‰ç«¯axiosçš„è¯·æ±‚æ‹¦æˆªçš„headersé‡Œé¢è¿™æ ·è®¾ç½® config.headers[&quot;authorization&quot;] = \`Bearer \${token}\`; å…¶ä¸­tokenæ˜¯ç™»å½•æ¥å£ç”Ÿæˆçš„</span>
</code></pre><p>koa-body</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-body&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;path&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> setting <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">multipart</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// æ”¯æŒæ–‡ä»¶ä¸Šä¼ </span>
  <span class="token literal-property property">formidable</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">maxFieldsSize</span><span class="token operator">:</span> <span class="token number">30</span> <span class="token operator">*</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">,</span> <span class="token comment">// æ–‡ä»¶ä¸Šä¼ å¤§å°é™åˆ¶30M</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">koaBody</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span>
</code></pre><p>koa-static</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-static&#39;</span><span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">koaStatic</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span><span class="token function">cwd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><p>koa-cors</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa2-cors&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> setting <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">origin</span><span class="token operator">:</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">KOA_CORS_ORIGIN</span><span class="token punctuation">,</span> <span class="token comment">//åªå…è®¸è¿™ä¸ªåŸŸåçš„è¯·æ±‚</span>
  <span class="token literal-property property">maxAge</span><span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span> <span class="token comment">//æŒ‡å®šæœ¬æ¬¡é¢„æ£€è¯·æ±‚çš„æœ‰æ•ˆæœŸï¼Œå•ä½ä¸ºç§’ã€‚</span>
  <span class="token literal-property property">credentials</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//æ˜¯å¦å…è®¸å‘é€Cookie</span>
  <span class="token literal-property property">allowMethods</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;GET&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;POST&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;PUT&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;DELETE&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//è®¾ç½®æ‰€å…è®¸çš„HTTPè¯·æ±‚æ–¹æ³•</span>
  <span class="token literal-property property">allowHeaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;Content-Type&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Authorization&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Accept&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//è®¾ç½®æœåŠ¡å™¨æ”¯æŒçš„æ‰€æœ‰å¤´ä¿¡æ¯å­—æ®µ</span>
  <span class="token literal-property property">exposeHeaders</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&#39;WWW-Authenticate&#39;</span><span class="token punctuation">,</span> <span class="token string">&#39;Server-Authorization&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token comment">//è®¾ç½®è·å–å…¶ä»–è‡ªå®šä¹‰å­—æ®µ</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">cors</span><span class="token punctuation">(</span>setting<span class="token punctuation">)</span>
</code></pre><p>mongoose</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> connectUrl <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">MONGODB_DB</span>
mongoose<span class="token punctuation">.</span><span class="token function">connect</span><span class="token punctuation">(</span>connectUrl<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;æ•°æ®åº“è¿æ¥å¤±è´¥ï¼š&#39;</span> <span class="token operator">+</span> err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;æ•°æ®åº“æˆåŠŸè¿æ¥åˆ°ï¼š&#39;</span> <span class="token operator">+</span> connectUrl<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> mongoose
</code></pre><p><strong>4ã€å°è£…å…¶ä»–ä¸­é—´ä»¶ï¼ˆä¹Ÿæ˜¯æ”¾åœ¨äº† settingï¼‰</strong></p><p>errHandleâ€”å¤„ç†å¼‚å¸¸</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token function-variable function">errHandle</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
  <span class="token comment">//å…¨å±€å¼‚å¸¸å¤„ç† å¦‚æœæ¥å£è°ƒç”¨æ—¶æœ‰é”™è¯¯å‘ç”Ÿ ä½†æ˜¯çœŸæ­£é€»è¾‘å¤„é—æ¼äº†å¯¹è¯¥å¼‚å¸¸çš„å¤„ç† å°±ä¼šåˆ°è¿™é‡Œæ¥æ‰§è¡Œ</span>
  <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;errä¿¡æ¯&#39;</span><span class="token punctuation">,</span> err<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span><span class="token string">&#39;æ²¡æœ‰æƒé™è®¿é—®&#39;</span><span class="token punctuation">,</span> <span class="token number">401</span><span class="token punctuation">)</span> <span class="token comment">//å¤„ç†jwtçš„tokené‰´æƒ</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ctx<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span> <span class="token comment">//å¤„ç†ä¸»è¦æ˜¯æ¥å£è°ƒç”¨äº§ç”Ÿçš„é”™è¯¯</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> errHandle
</code></pre><p>htmlHistoryâ€”å…¼å®¹å‰ç«¯æ‰˜ç®¡çš„é™æ€é¡µé¢çš„ history æ¨¡å¼ hash æ¨¡å¼ä¸éœ€è¦</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> <span class="token function-variable function">htmlHistory</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// history ä¸­é—´ä»¶</span>
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token string">&#39;/web/&#39;</span> <span class="token comment">// éœ€è¦åˆ¤æ–­çš„è·¯å¾„</span>
  <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// ç­‰å¾…è¯·æ±‚æ‰§è¡Œå®Œæ¯•</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span> <span class="token operator">&amp;&amp;</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>url<span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// åˆ¤æ–­æ˜¯å¦ç¬¦åˆæ¡ä»¶</span>
    ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token string">&#39;text/html; charset=utf-8&#39;</span> <span class="token comment">// ä¿®æ”¹å“åº”ç±»å‹</span>
    ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span><span class="token string">&#39;.&#39;</span> <span class="token operator">+</span> path <span class="token operator">+</span> <span class="token string">&#39;index.html&#39;</span><span class="token punctuation">)</span> <span class="token comment">// ä¿®æ”¹å“åº”ä½“</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> htmlHistory
</code></pre><p>routerResponseâ€”ç»Ÿä¸€è¯·æ±‚è¿”å›ä½“</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> option <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">successCode</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token literal-property property">successMsg</span><span class="token operator">:</span> <span class="token string">&#39;æ¥å£è°ƒç”¨æˆåŠŸ&#39;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">failCode</span><span class="token operator">:</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token comment">//é»˜è®¤çš„å¼‚å¸¸ç </span>
  <span class="token literal-property property">failMsg</span><span class="token operator">:</span> <span class="token string">&#39;æ¥å£è°ƒç”¨å¤±è´¥&#39;</span><span class="token punctuation">,</span> <span class="token comment">//é»˜è®¤çš„å¼‚å¸¸æ¶ˆæ¯</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">routerResponse</span><span class="token punctuation">(</span><span class="token parameter">option <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> next</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ctx<span class="token punctuation">.</span><span class="token function-variable function">success</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> msg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//æ¥å£æˆåŠŸæ—¶æˆ‘ä»¬æ›´æœŸæœ›å¾—åˆ°æ¥å£è°ƒç”¨æˆåŠŸåçš„æ•°æ®ï¼Œè™½ç„¶æˆåŠŸè°ƒç”¨åæç¤ºæ¶ˆæ¯å¯èƒ½ä¸æ˜¯å¾ˆé‡è¦ï¼Œä½†æ˜¯æœ‰æ—¶ä¹Ÿéœ€è¦ï¼Œæ‰€ä»¥åŠ ä¸Š</span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> option<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">&#39;json&#39;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rsCode</span><span class="token operator">:</span> option<span class="token punctuation">.</span>successCode<span class="token punctuation">,</span>
        <span class="token literal-property property">rsCause</span><span class="token operator">:</span> msg <span class="token operator">||</span> option<span class="token punctuation">.</span>successMsg<span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> data <span class="token operator">||</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    ctx<span class="token punctuation">.</span><span class="token function-variable function">fail</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">msg<span class="token punctuation">,</span> code</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//å‘ç”Ÿå¼‚å¸¸æ—¶å‰ç«¯æœŸæœ›å¾—åˆ°å¼‚å¸¸ä¿¡æ¯æè¿°å’Œå¯¹åº”çš„çŠ¶æ€ç </span>
      ctx<span class="token punctuation">.</span>type <span class="token operator">=</span> option<span class="token punctuation">.</span>type <span class="token operator">||</span> <span class="token string">&#39;json&#39;</span>
      ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">rsCode</span><span class="token operator">:</span> code <span class="token operator">||</span> option<span class="token punctuation">.</span>failCode<span class="token punctuation">,</span>
        <span class="token literal-property property">rsCause</span><span class="token operator">:</span> msg <span class="token operator">||</span> option<span class="token punctuation">.</span>failMsg<span class="token punctuation">,</span>
        <span class="token literal-property property">data</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token function">routerResponse</span><span class="token punctuation">(</span>option<span class="token punctuation">)</span>
</code></pre><p>è¿™æ ·å¤„ç†äº†ä¹‹åï¼Œåœ¨é¡µé¢é‡Œé¢å°±å¯ä»¥è¿™æ ·ç”¨</p><pre class="language-js"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token string">&#39;è·å–æ‰€æœ‰ç”¨æˆ·æˆåŠŸ&#39;</span><span class="token punctuation">)</span>
</code></pre><p>æˆ–è€…è¿™æ ·</p><pre class="language-js"><code class="language-js">ctx<span class="token punctuation">.</span><span class="token function">fail</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>message<span class="token punctuation">)</span>
</code></pre><p>å‰ç«¯æ‹¿åˆ°çš„è¿”å›ä½“å°±æ˜¯</p><pre class="language-js"><code class="language-js"><span class="token punctuation">{</span>
    <span class="token literal-property property">rsCode</span><span class="token operator">:</span>xxx<span class="token punctuation">,</span>
    <span class="token literal-property property">rsCause</span><span class="token operator">:</span>xxxx<span class="token punctuation">,</span>
    <span class="token literal-property property">data</span><span class="token operator">:</span>xxx
<span class="token punctuation">}</span>
</code></pre><p><strong>æ³¨æ„ï¼šä»¥ä¸‹ä»£ç éƒ½ä¼šç”¨åˆ°è¿™ä¸ªå°è£…çš„ä¸­é—´ä»¶ ä¿è¯æ¥å£è¿”å›ä½“ç»Ÿä¸€</strong></p><p>5ã€æœ€æ¿€åŠ¨çš„å†™æ¥å£éƒ¨åˆ† ğŸ˜˜</p><p>ç™»å½•è·å– tokenâ€”login.js (è¿™é‡Œåšç¤ºä¾‹ï¼Œæ‰€ä»¥æ²¡æœ‰æ¥å‚æ•°ï¼Œè¿˜æ˜¯è¦æ¥ä¸€ä¸‹ä¿¡æ¯çš„ï¼Œç„¶ååŠ å…¥åˆ° token ç”Ÿæˆé‡Œé¢)</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwtToken <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;jsonwebtoken&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token string">&#39;/login&#39;</span><span class="token punctuation">,</span> <span class="token comment">//åŸºæœ¬æ¥å£çš„å‰ç¼€ å‰ç«¯è°ƒç”¨æ—¶åœ°å€ä¸º&#39;/login&#39;  å³ä¼šå’Œä¸‹é¢çš„åœ°å€æ‹¼æ¥</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//payloadä¸­åŠ å…¥ç”¨æˆ·å”¯ä¸€ä¿¡æ¯ ä¾‹å¦‚ç”¨æˆ·å”¯ä¸€id phoneNumber passwordç­‰</span>
  <span class="token keyword">const</span> token <span class="token operator">=</span> jwtToken<span class="token punctuation">.</span><span class="token function">sign</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">uid</span><span class="token operator">:</span> <span class="token string">&#39;123&#39;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">JWT_SECRET</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">expiresIn</span><span class="token operator">:</span> <span class="token string">&#39;15d&#39;</span><span class="token punctuation">,</span> <span class="token comment">//è®¾ç½®è¯¥tokençš„è¿‡æœŸæ—¶é—´</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> <span class="token string">&#39;è·å–tokenæˆåŠŸ&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre><p>æ–‡ä»¶çš„ä¸Šä¼ å’Œä¸‹è½½â€”file.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> sendfile <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-sendfile&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;fs&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token string">&#39;/file&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ä¸Šä¼ æ–‡ä»¶</span>
router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/upload&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> filepath<span class="token punctuation">,</span> originalFilename <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>files<span class="token punctuation">.</span>file <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> <span class="token comment">// è·å–ä¸Šä¼ æ–‡ä»¶</span>
  <span class="token keyword">const</span> reader <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createReadStream</span><span class="token punctuation">(</span>filepath<span class="token punctuation">)</span>
  <span class="token keyword">let</span> filePath <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">upload/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>originalFilename<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span> <span class="token comment">//å‚¨å­˜åœ¨nodeæœåŠ¡ä¸­çš„uploadæ–‡ä»¶å¤¹ä¸‹</span>
  <span class="token comment">// åˆ›å»ºå¯å†™æµ</span>
  <span class="token keyword">const</span> upStream <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">createWriteStream</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span>
  <span class="token comment">// å¯è¯»æµé€šè¿‡ç®¡é“å†™å…¥å¯å†™æµ</span>
  reader<span class="token punctuation">.</span><span class="token function">pipe</span><span class="token punctuation">(</span>upStream<span class="token punctuation">)</span>
  <span class="token keyword">const</span> resData <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">fileUrl</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">KOA_CORS_ORIGIN</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>filePath<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">,</span> <span class="token comment">//å‰é¢é‚£ä¸ªéƒ¨åˆ†åæœŸå¯ä»¥æ›¿æ¢ä¸ºå…¶ä»–å¯ä»¥è®¿é—®çš„å‰ç¼€ è¿™é‡Œæœ¬åœ°æµ‹è¯•ç”¨</span>
  <span class="token punctuation">}</span>
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>resData<span class="token punctuation">,</span> <span class="token string">&#39;æ–‡ä»¶ä¸Šä¼ æˆåŠŸ&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// ä¸‹è½½æ–‡ä»¶</span>
router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/download&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;ctx.request.query&#39;</span><span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query<span class="token punctuation">)</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> fileName <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>query
  <span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">upload/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>fileName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">\`</span></span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
  ctx<span class="token punctuation">.</span><span class="token function">attachment</span><span class="token punctuation">(</span><span class="token function">decodeURI</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//urlç¼–ç  è½¬æ¢å®¹æ˜“å¼•èµ·æ­§ä¹‰çš„å­—ç¬¦ ä¾‹å¦‚ä¸­æ–‡å­—ç¬¦</span>
  <span class="token keyword">await</span> <span class="token function">sendfile</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> path<span class="token punctuation">)</span> <span class="token comment">//å‰ç«¯é¡µé¢éœ€è¦å¯¹æ–‡ä»¶åè¿›è¡ŒdecodeURIComponentè§£ç  è§£ç åèƒ½å¤Ÿæ‹¿åˆ°çœŸæ­£çš„åå­—</span>
  <span class="token comment">//å¦å¤– å‰ç«¯éœ€è¦ä»è¿”å›ä½“ä¸­è·å–æ–‡ä»¶åç»™aæ ‡ç­¾ ä»é‡Œé¢çš„headersçš„content-dispositionä¸­æˆªå–è·å¾—---ã€‹ã€‹ã€‹ res.headers[&quot;content-disposition&quot;]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre><p>åŸºæœ¬ä¸Šéƒ½ä¼šç”¨åˆ°çš„ user ä¿¡æ¯å¤„ç†</p><p>1ã€æˆ‘ä»¬å…ˆå»ºä¸ªè¡¨ï¼Œç›´æ¥ç”¨ä»£ç å»ºç«‹</p><p>src/models/user.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> <span class="token punctuation">{</span> Schema<span class="token punctuation">,</span> model <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;mongoose&#39;</span><span class="token punctuation">)</span>

<span class="token keyword">const</span> CompletedSchema <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Schema</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">sex</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span> <span class="token keyword">enum</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token literal-property property">phone</span><span class="token operator">:</span> <span class="token punctuation">{</span> <span class="token literal-property property">type</span><span class="token operator">:</span> String<span class="token punctuation">,</span> <span class="token literal-property property">required</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span> <span class="token literal-property property">collection</span><span class="token operator">:</span> <span class="token string">&#39;users&#39;</span><span class="token punctuation">,</span> <span class="token literal-property property">versionKey</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token literal-property property">timestamps</span><span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span>
<span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> UserForm <span class="token operator">=</span> <span class="token function">model</span><span class="token punctuation">(</span><span class="token string">&#39;UserForm&#39;</span><span class="token punctuation">,</span> CompletedSchema<span class="token punctuation">)</span>
</code></pre><p>å¦‚ä»£ç æ‰€ç¤ºï¼Œè¡¨ç¤ºæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªåä¸º users çš„æ•°æ®è¡¨ï¼Œæ¯ä¸€ä¸ª user å–ƒï¼Œä»–æœ‰ä¸‰ä¸ªåŸºæœ¬ä¿¡æ¯ï¼Œåˆ†åˆ«æ˜¯å§“åï¼Œæ€§åˆ«å’Œç”µè¯ï¼Œå…¶ä¸­å‘¢ï¼Œname å’Œ phone éƒ½æ˜¯å­—ç¬¦ä¸²ï¼Œsex åªèƒ½å– 0 å’Œ 1ï¼Œç†Ÿæ‚‰ Typescript çš„å¤§ä½¬åº”è¯¥æ„Ÿè§‰å¾ˆäº²åˆ‡ï¼Œè¿™ä¸å°±æ˜¯æšä¸¾å˜›ï¼Œé™åˆ¶åªèƒ½å–è¿™ä¸¤ä¸ªå€¼ã€‚require è¡¨ç¤ºè¿™ä¸ªå­—æ®µéœ€è¦æœ‰å€¼ã€‚å…¶ä»–çš„å°±ä¸å¤šè¯´å•¦ã€‚mongoose è¯¦ç»†çš„ä½¿ç”¨å¯ä»¥å‚è€ƒè¿™ä¸ªå¤§ä½¬å†™çš„æ–‡ç« ï¼š<a href="https://juejin.cn/post/6844904054196273159" target="_blank" rel="noopener">ä½ çœŸçš„äº†è§£ mongoose å—ï¼Ÿ - æ˜é‡‘ (juejin.cn)</a></p><p>2ã€å¼€å§‹å†™å…³äº user çš„æ¥å£(ä½œå‚è€ƒï¼Œä¸ä¸€å®šæ˜¯æœ€å¥½çš„å†™æ³•ï¼Œä½†è¿è¡Œç»“æœè‚¯å®šæ˜¯æ­£ç¡®çš„å“ˆ ğŸ˜‚)</p><p>src/api/user.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Router <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa-router&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Router</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">prefix</span><span class="token operator">:</span> <span class="token string">&#39;/user&#39;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> UserForm <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;../models/user&#39;</span> <span class="token comment">//å°†æˆ‘ä»¬åˆšåˆšçš„è¡¨äº§ç”Ÿçš„modelæ‹¿è¿‡æ¥,é€šè¿‡ä»–æˆ‘ä»¬å®ç°å¯¹æ•°æ®åº“çš„æ“ä½œã€‚</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> users <span class="token operator">=</span> <span class="token keyword">await</span> UserForm<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//æŸ¥è¯¢è¡¨ä¸­æ‰€æœ‰æ•°æ®</span>
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>users<span class="token punctuation">,</span> <span class="token string">&#39;è·å–æ‰€æœ‰ç”¨æˆ·æˆåŠŸ&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&#39;/getUserInfo&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">è·å–idä¸º</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">çš„ç”¨æˆ·</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">post</span><span class="token punctuation">(</span><span class="token string">&#39;/add&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">//</span>
  <span class="token keyword">await</span> UserForm<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">)</span> <span class="token comment">//å‘è¡¨ä¸­æ’å…¥æ•°æ®</span>
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">,</span> <span class="token string">&#39;ç”¨æˆ·ä¿¡æ¯æäº¤æˆåŠŸ&#39;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&#39;/:id&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">ä¿®æ”¹idä¸º</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">çš„ç”¨æˆ·</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

router<span class="token punctuation">.</span><span class="token function">del</span><span class="token punctuation">(</span><span class="token string">&#39;/:id&#39;</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token parameter">ctx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> id <span class="token punctuation">}</span> <span class="token operator">=</span> ctx<span class="token punctuation">.</span>params
  ctx<span class="token punctuation">.</span><span class="token function">success</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">\`</span><span class="token string">åˆ é™¤idä¸º</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">\${</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">çš„ç”¨æˆ·</span><span class="token template-punctuation string">\`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> router
</code></pre><p>æœ€åé™„ä¸Šæˆ‘ä»¬ç¨‹åºçš„è¿è¡Œçš„åŸºçŸ³â€”â€”app.js</p><pre class="language-js"><code class="language-js"><span class="token keyword">const</span> Koa <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;koa&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> mongoose <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/mongoose&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> cors <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/koa2-cors&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> jwt <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/jwt&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> koaBody <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/koa-body&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> koaStatic <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/koa-static&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> htmlHistory <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/html-history&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> routerResponse <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/routerResponse&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> errHandle <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/setting/error-handle&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Koa</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">//apiéƒ¨åˆ†</span>
<span class="token keyword">const</span> user <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/api/user&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> login <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/api/login&#39;</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> file <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&#39;./src/api/file&#39;</span><span class="token punctuation">)</span>

<span class="token comment">//åŸºç¡€éƒ¨åˆ†</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>cors<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>koaBody<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>routerResponse<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>errHandle<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>jwt<span class="token punctuation">)</span>
<span class="token comment">//apiéƒ¨åˆ†</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>login<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">routes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment">//é™æ€é¡µé¢æ‰˜ç®¡</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>htmlHistory<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>koaStatic<span class="token punctuation">)</span> <span class="token comment">//å› ä¸ºå‰ç«¯æ‰“åŒ…çš„é¡µé¢æ–‡ä»¶æ”¾åœ¨äº†webæ–‡ä»¶å¤¹ä¸‹ å‰ç«¯éœ€è¦å°†é¡¹ç›®publicPathä¿®æ”¹ä¸º&#39;/web/&#39; å†æ‰“åŒ…æ”¾å…¥ æˆ‘è¿™é‡Œå‰ç«¯ç”¨çš„æ˜¯vue-routerçš„historyæ¨¡å¼</span>
app<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">9000</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;app started at port 9000...&#39;</span><span class="token punctuation">)</span>
</code></pre><p>é¡ºä¾¿çœ‹çœ‹ package.json</p><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodejs-koa2&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.7.8&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodejs for network&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;app.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon scripts/development.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon scripts/test.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;prod&quot;</span><span class="token operator">:</span> <span class="token string">&quot;nodemon scripts/production.js&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;babel-plugin-transform-es2015-modules-commonjs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;babel-register&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.26.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;dotenv&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^16.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jsonwebtoken&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^8.5.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.13.4&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-body&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-jwt&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^4.0.3&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-router&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^10.1.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-sendfile&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa-static&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.0.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;koa2-cors&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.6&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;mongoose&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^6.3.1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;nodemon&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.0.15&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;prettier&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^2.6.2&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><p>è‡³æ­¤ï¼Œå®Œç¾æ’’èŠ±ï¼Œæ„Ÿè°¢ä½ å®è´µçš„å‡ åˆ†é’Ÿï¼Œå“ˆå“ˆå“ˆå“ˆ ğŸ¤—ã€‚</p>`,53),e=[o],i={__name:"koa2",setup(c,{expose:n}){return n({frontmatter:{}}),(l,k)=>(s(),a("div",t,e))}};export{i as default};
